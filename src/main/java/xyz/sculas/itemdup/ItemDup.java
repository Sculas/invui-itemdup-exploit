package xyz.sculas.itemdup;

import de.studiocode.invui.gui.impl.SimpleGUI;
import de.studiocode.invui.item.builder.ItemBuilder;
import de.studiocode.invui.item.impl.SimpleItem;
import de.studiocode.invui.window.impl.single.SimpleWindow;
import io.papermc.paper.event.player.AsyncChatEvent;
import net.kyori.adventure.text.serializer.plain.PlainTextComponentSerializer;
import org.bukkit.Bukkit;
import org.bukkit.Material;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.plugin.java.JavaPlugin;

public final class ItemDup extends JavaPlugin implements Listener {
    @Override
    public void onEnable() {
        getServer().getPluginManager().registerEvents(this, this);
        getLogger().info("ItemDup has been enabled. Please type \"opengui\" in chat to open the GUI.");
        getLogger().severe("DO NOT USE THIS PLUGIN IN PRODUCTION. IT IS FOR TESTING ONLY.");
    }

    @EventHandler
    public void onChatMessage(AsyncChatEvent event) {
        final var msg = PlainTextComponentSerializer.plainText().serialize(event.originalMessage());
        if (msg.equalsIgnoreCase("opengui")) {
            Bukkit.getScheduler().runTask(this, () -> {
                var gui = new SimpleGUI(9, 3);
                gui.fillBorders(new SimpleItem(new ItemBuilder(Material.BLACK_STAINED_GLASS_PANE)), false);
                var window = new SimpleWindow(event.getPlayer(), "ItemDup", gui);
                // Make sure the player can't close the GUI themselves.
                // Because closing the GUI yourself doesn't cause the exploit.
                window.setCloseable(false);
                window.show();
                // This call to close(true) causes the exploit:
                Bukkit.getScheduler().runTaskLater(this, () -> window.close(true), 3 * 20L);
            });
        }
    }
}
